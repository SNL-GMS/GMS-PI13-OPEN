# Standard Test Data Set Loader

The purpose of this service is to load the [standard test data set](/test-data/standard_test_data_set)
into GMS (i.e. PostgreSQL and Cassandra).

## Background

This service was created in order to reduce the significant amount of manual
interaction required in order to generate and load test data into GMS.

## Complications

There is a backwards dependency on the scripts and loaders in the STDS loader on
data generated by the station reference loader preparation script.

That means that the directory where the data generated by [gen_station_ref.sh](/config/station-reference/gen_station_ref.sh)
is placed needs to be passed to the [docker-build-prep.sh](/java/gms/shared/utilities/standard-test-data-set/docker-build-prep.sh)
script in this directory.

This generated data directory is named `station_ref_data` by the station ref
docker-build-prep.sh script by default.

## Building

### Setup

Prior to building, set the GMS_INSTALL_DIR variable for ease of use:

```
# From the root directory of the gms-common repo, run
export GMS_INSTALL_DIR=$(pwd)
```

### Build

In order to generate the STDS loader locally, you'll need first
initialize the [test-data/standard_test_data_set](test-data/standard_test_data_set)
git submodule:

```
# From gms-common's root directory, run
cd $GMS_INSTALL_DIR
git submodule update --init test-data/standard_test_data_set
```

Next, generate the station reference data

```
cd $GMS_INSTALL_DIR
bash config/station-reference/docker-build-prep.sh
```

Then, run the docker build preparation script. This moves the appropriate files
out of the standard test data set git submodule into the appropriate folders,
creates the generated test-data, and builds and un-tars the response loader:

```
bash $GMS_INSTALL_DIR/java/gms/shared/utilities/standard-test-data-set/docker-build-prep.sh $GMS_INSTALL_DIR/config/station-reference/station_ref_data
```

Your environment is now ready to build the station_ref_loader Docker image. Run:

```
# DOCKER_REGISTRY needs to be set to the location of gms/centos7/openjdk11:latest
# This could be 'localhost' or a remote docker registry.
export DOCKER_REGISTRY=<registry_hostname>
cd $GMS_INSTALL_DIR/java/gms/shared/utilities/standard-test-data-set
docker build -t standard-test-data-set-loader:<tag> .
```

## Usage

In order to run the loader, you first need to run the station_ref_loader as part
of the GMS network:

```
docker run -it --rm --network <network_name> station-ref-loader:<tag>
```

Then, simply need to mount it into the network with postgres:

```
docker run -it --rm --network <network_name> standard_test_data_set_loader:<tag>
```

## Failure recovery

If the load fails part-way through, you will need to empty the databases and start from scratch.
